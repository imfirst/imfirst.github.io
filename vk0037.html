<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–ö PRO Configurator v4.0 (Ultimate Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --success: #27ae60;
            --danger: #c0392b;
            --bg: #ecf0f1;
            --panel-bg: #ffffff;
            --border: #bdc3c7;
            --header-bg: #dfe6e9;
            --hover-row: #f1f2f6;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 10px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 13px;
        }

        /* --- LAYOUT GRID --- */
        .app-container {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 15px;
            height: 100%;
        }

        /* --- SIDEBAR PANEL --- */
        .sidebar {
            background: var(--panel-bg);
            border-radius: 6px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 2px 0 10px rgba(0,0,0,0.08);
        }

        .sidebar-header {
            padding: 15px;
            background: var(--primary);
            color: white;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #34495e;
        }

        .sidebar-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        /* --- CONTROLS STYLING --- */
        fieldset {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            background: #fafafa;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }

        legend {
            font-weight: 800;
            color: var(--accent);
            padding: 0 8px;
            font-size: 12px;
            text-transform: uppercase;
        }

        .form-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        label { 
            color: #34495e; 
            font-weight: 600; 
            font-size: 13px;
        }

        select, input[type="number"], input[type="text"] {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 210px;
            font-size: 13px;
            transition: border-color 0.2s;
        }
        
        select:focus, input:focus {
            border-color: var(--accent);
            outline: none;
        }

        input[type="checkbox"] { 
            transform: scale(1.3); 
            cursor: pointer; 
            margin-right: 10px;
        }

        /* --- BATHROOM CARD --- */
        .bath-card {
            background: white;
            border: 1px solid #dcdcdc;
            border-left: 5px solid var(--accent);
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 5px;
            transition: box-shadow 0.2s;
        }
        
        .bath-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .bath-header {
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            color: var(--primary);
        }

        .device-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fcfcfc;
            padding: 5px 8px;
            border-bottom: 1px dashed #eee;
            border-radius: 3px;
        }
        
        .device-item:hover {
            background-color: #f0f8ff;
        }
        
        .device-item label { 
            display: flex; 
            align-items: center; 
            width: 100%; 
            cursor: pointer;
            font-weight: 500;
        }
        
        .device-item input[type="number"] { 
            width: 60px; 
            text-align: center; 
            font-weight: bold;
        }

        /* --- BUTTONS --- */
        .btn-panel {
            padding-top: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
        }

        .btn {
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-main { 
            background: var(--success); 
            color: white; 
        }
        .btn-main:hover { 
            background: #219150; 
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }
        
        .btn-sec { 
            background: #546e7a; 
            color: white; 
        }
        .btn-sec:hover { 
            background: #455a64; 
        }

        /* --- MAIN TABLE AREA --- */
        .main-view {
            background: var(--panel-bg);
            border-radius: 6px;
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .table-container {
            overflow: auto;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1100px;
        }

        thead th {
            position: sticky;
            top: 0;
            background: var(--header-bg);
            color: #2d3436;
            padding: 12px 10px;
            font-size: 12px;
            border-bottom: 3px solid #b2bec3;
            text-align: left;
            z-index: 100;
            text-transform: uppercase;
            font-weight: 800;
        }

        tbody td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            font-size: 12px;
            color: #2c3e50;
        }

        tr:nth-child(even) { background-color: #fcfcfc; }
        tr:hover { background-color: var(--hover-row); }

        .group-header td {
            background-color: #ecf0f1;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            padding: 12px 15px;
            border-top: 2px solid #bdc3c7;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        .total-row td {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 14px;
            padding: 15px 10px;
            text-transform: uppercase;
        }

        .col-n { width: 40px; text-align: center; color: #7f8c8d; }
        .col-code { width: 130px; font-family: 'Consolas', monospace; font-weight: 700; color: #444; }
        .col-brand { width: 100px; color: #7f8c8d; }
        .col-unit { width: 50px; text-align: center; }
        .col-qty { width: 60px; text-align: center; font-weight: 800; background: #fffde7; border-left: 1px solid #eee; border-right: 1px solid #eee; }
        .col-price { width: 90px; text-align: right; font-family: monospace; color: #e67e22; }
        .col-sum { width: 100px; text-align: right; font-weight: bold; font-family: monospace; color: #27ae60; background: #f0fff4; }
        .col-note { width: 200px; font-size: 11px; color: #666; font-style: italic; }
        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 5px; border: 2px solid #f1f1f1; }
        ::-webkit-scrollbar-thumb:hover { background: #95a5a6; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <span>PRO Configurator v4.0</span>
            <span style="font-size: 10px; opacity: 0.7;">ULTIMATE</span>
        </div>
        
        <div class="sidebar-content">
            <fieldset>
                <legend>–ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏—Å—Ç–µ–º—ã</legend>
                <div class="form-row">
                    <label>–¢–∏–ø –≤–≤–æ–¥–∞:</label>
                    <select id="sysType" onchange="App.onSystemChange()">
                        <option value="door">–û—Ç –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏ (–ö–≤–∞—Ä—Ç–∏—Ä–∞)</option>
                        <option value="riser">–°—Ç–æ—è–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>–î–∏–∞–º–µ—Ç—Ä –≤–≤–æ–¥–∞:</label>
                    <select id="inletDia" onchange="App.update()">
                    </select>
                </div>
                <div class="form-row">
                    <label>–ö–æ–ª-–≤–æ –≤–≤–æ–¥–æ–≤ (–ø–∞—Ä):</label>
                    <input type="number" id="inletCount" value="1" min="1" onchange="App.update()">
                </div>
            </fieldset>

            <fieldset>
                <legend>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</legend>
                <div class="form-row">
                    <label>–ó–∞–ø–æ—Ä–Ω–∞—è –∞—Ä–º–∞—Ç—É—Ä–∞:</label>
                    <select id="brandValve" onchange="App.update()">
                        <option value="valtec">Valtec (–ò—Ç–∞–ª–∏—è/–ö–∏—Ç–∞–π)</option>
                        <option value="far">FAR (–ò—Ç–∞–ª–∏—è)</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>–¢—Ä—É–±—ã –∏ —Ñ–∏—Ç–∏–Ω–≥–∏:</label>
                    <select id="brandPipe" onchange="App.update()">
                        <option value="rehau">Rehau RAUTITAN (Pex-a)</option>
                        <option value="stout">Stout (Pex-a)</option>
                        <option value="tece">TECEflex (Pex-c)</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</legend>
                <div class="device-item">
                    <label><input type="checkbox" id="comp_valve" checked onchange="App.update()"> –ö—Ä–∞–Ω –≤–≤–æ–¥–Ω–æ–π</label>
                </div>
                <div class="device-item">
                    <label><input type="checkbox" id="comp_neptun" checked onchange="App.update()"> –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –ø—Ä–æ—Ç–µ—á–µ–∫</label>
                </div>
                <div class="device-item">
                    <label><input type="checkbox" id="comp_mud" checked onchange="App.update()"> –§–∏–ª—å—Ç—Ä –≥—Ä—è–∑–µ–≤–∏–∫ (–∫–æ—Å–æ–π)</label>
                </div>
                <div class="device-item">
                    <label><input type="checkbox" id="comp_meter" checked onchange="App.update()"> –°—á–µ—Ç—á–∏–∫ –≤–æ–¥—ã</label>
                </div>
                <div class="device-item">
                    <label><input type="checkbox" id="comp_check" checked onchange="App.update()"> –û–±—Ä–∞—Ç–Ω—ã–π –∫–ª–∞–ø–∞–Ω</label>
                </div>
                <div class="device-item">
                    <label><input type="checkbox" id="comp_fine" checked onchange="App.update()"> –§–∏–ª—å—Ç—Ä —Ç–æ–Ω–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ (100–º–∫–º)</label>
                </div>
                <div class="device-item">
                    <label><input type="checkbox" id="comp_red" checked onchange="App.update()"> –†–µ–¥—É–∫—Ç–æ—Ä –¥–∞–≤–ª–µ–Ω–∏—è</label>
                </div>
                <div class="device-item">
                    <label><input type="checkbox" id="comp_viking" onchange="App.update()"> –ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä (–í–∏–∫–∏–Ω–≥)</label>
                </div>
                <div class="device-item" style="background-color: #fff3e0;">
                    <label><input type="checkbox" id="comp_fire" onchange="App.update()"> –®–∫–∞—Ñ –ø–æ–∂–∞—Ä–æ—Ç—É—à–µ–Ω–∏—è (–ü—É–ª—å—Å)</label>
                </div>
                <div class="device-item" style="border-top: 2px solid #eee;">
                    <label><input type="checkbox" id="comp_trap_global" onchange="App.update()"> <b>–¢—Ä–∞–ø –¥—É—à–µ–≤–æ–π (HL510N)</b></label>
                </div>
            </fieldset>

            <fieldset>
                <legend>–ó–æ–Ω—ã –≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è</legend>
                <div class="form-row">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∞–Ω—É–∑–ª–æ–≤:</label>
                    <input type="number" id="bathCount" value="1" min="1" max="10" onchange="App.updateBathCount()">
                </div>
                <div id="bathContainer">
                </div>
            </fieldset>

            <div class="btn-panel">
                <button class="btn btn-main" onclick="App.exportExcel()">
                    <span>üìÑ</span> –≠–∫—Å–ø–æ—Ä—Ç –≤ xlsx
                </button>
                <button class="btn btn-sec" onclick="App.exportJSON()">
                    <span>üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                </button>
                <input type="file" id="importFile" style="display:none" onchange="App.importProject(this)" accept=".json,.xlsx">
                <button class="btn btn-sec" onclick="document.getElementById('importFile').click()">
                    <span>üìÇ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>
        </div>
    </aside>

    <main class="main-view">
        <div class="table-container">
            <table id="specTable">
                <thead>
                    <tr>
                        <th class="col-n">‚Ññ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</th>
                        <th class="col-code">–ê—Ä—Ç–∏–∫—É–ª</th>
                        <th class="col-brand">–ü—Ä–æ–∏–∑–≤.</th>
                        <th class="col-unit">–ï–¥.</th>
                        <th class="col-qty">–ö–æ–ª.</th>
                        <th class="col-price">–¶–µ–Ω–∞</th>
                        <th class="col-sum">–°—É–º–º–∞</th>
                        <th class="col-note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="specBody">
                </tbody>
                <tfoot id="specFoot">
                </tfoot>
            </table>
        </div>
    </main>
</div>

<script>
const DB = {
    armature: {
        valtec: {
            brand: 'VALTEC',
            valve: { name: '–ö—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π BASE —Å –ø–æ–ª—É—Å–≥–æ–Ω–æ–º, 1/2" (–±–∞–±–æ—á–∫–∞)', art: 'VT.227.N.04', brand: 'VALTEC', price: 850 },
            valveW: { name: '–ö—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π, –≤–Ω.-–Ω–∞—Ä., 1/2" (–±–∞–±–æ—á–∫–∞)', art: 'VT.218.N.04', brand: 'VALTEC', price: 620 }, 
            mud: { name: '–§–∏–ª—å—Ç—Ä –∫–æ—Å–æ–π (–≥—Ä—è–∑–µ–≤–∏–∫) 500 –º–∫–º, 1/2"', art: 'VT.190.N.04', brand: 'VALTEC', price: 450 },
            fine: { name: '–§–∏–ª—å—Ç—Ä –ø—Ä–æ–º—ã–≤–Ω–æ–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π 100 –º–∫–º, 1/2"', art: 'VT.389.N.04', brand: 'VALTEC', price: 2100 }, 
            red: { name: '–†–µ–¥—É–∫—Ç–æ—Ä –¥–∞–≤–ª–µ–Ω–∏—è –º–µ–º–±—Ä–∞–Ω–Ω—ã–π 1-7 –±–∞—Ä, 1/2"', art: 'VT.085.N.0407', brand: 'VALTEC', price: 2800 },
            check: { name: '–ö–ª–∞–ø–∞–Ω –æ–±—Ä–∞—Ç–Ω—ã–π, 1/2"', art: 'VT.161.N.04', brand: 'VALTEC', price: 480 },
            collector: { base: 'VTc.560.N', name: '–ö–æ–ª–ª–µ–∫—Ç–æ—Ä Valtec —Å —Ä–µ–≥. –≤–µ–Ω—Ç. 3/4"', brand: 'VALTEC', price: 1200 },
            elbowMale: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –ø—Ä—è–º–æ–π –ù–í 3/4"', art: 'VTr.092.N.0005', brand: 'VALTEC', price: 320 }, 
            elbowFem: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –ø—Ä—è–º–æ–π –í–† 3/4"', art: 'VTr.090.N.0005', brand: 'VALTEC', price: 310 }, 
            cap: { name: '–ó–∞–≥–ª—É—à–∫–∞ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞ 3/4" –í–†', art: 'VTr.590.N.0005', brand: 'VALTEC', price: 150 },
            bracket: { name: '–ö—Ä–æ–Ω—à—Ç–µ–π–Ω—ã –¥–ª—è –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞ 3/4" (–ø–∞—Ä–∞)', art: 'VTc.130.N.0500', brand: 'VALTEC', price: 950 }
        },
        far: {
            brand: 'FAR',
            valve: { name: '–ö—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π –ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π 1/2" –í–†-–ù–† (—Ä—É—á–∫–∞)', art: 'FA 3000 12', brand: 'FAR', price: 1450 },
            valveW: { name: '–ö—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π 1/2" –í–†-–ù–† (–±–∞–±–æ—á–∫–∞)', art: 'FA 3010 12', brand: 'FAR', price: 1350 },
            mud: { name: '–§–∏–ª—å—Ç—Ä –≥—Ä—É–±–æ–π –æ—á–∏—Å—Ç–∫–∏ 1/2" (–±—Ä–æ–Ω–∑–∞) 600–º–∫–º', art: 'FA 3900 12', brand: 'FAR', price: 1800 },
            fine: { name: '–§–∏–ª—å—Ç—Ä –ø—Ä–æ–º—ã–≤–Ω–æ–π 100 –º–∫–º 1/2" —Å –º–∞–Ω–æ–º–µ—Ç—Ä–æ–º', art: 'FA 3938 12', brand: 'FAR', price: 6500 },
            red: { name: '–†–µ–¥—É–∫—Ç–æ—Ä –¥–∞–≤–ª–µ–Ω–∏—è 1/2" (—Å –º–∞–Ω–æ–º–µ—Ç—Ä–æ–º 0-10 –±–∞—Ä)', art: 'FA 2815 12', brand: 'FAR', price: 7200 },
            check: { name: '–ö–ª–∞–ø–∞–Ω –æ–±—Ä–∞—Ç–Ω—ã–π 1/2" (—Ö—Ä–æ–º)', art: 'FA 2100 12', brand: 'FAR', price: 1100 },
            collector: { base: 'FA 3825', name: '–ö–æ–ª–ª–µ–∫—Ç–æ—Ä FAR Multifar 3/4" (Eurokonus)', brand: 'FAR', price: 2200 }, 
            elbowMale: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –ù–í 3/4" (—Ö—Ä–æ–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)', art: 'FA 5050 34', brand: 'FAR', price: 850 }, 
            elbowFem: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –í–† 3/4" (—Ö—Ä–æ–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)', art: 'FA 5000 34', brand: 'FAR', price: 820 },
            cap: { name: '–ó–∞–≥–ª—É—à–∫–∞ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞ 3/4"', art: 'FA 4150 34', brand: 'FAR', price: 450 },
            bracket: { name: '–ö—Ä–æ–Ω—à—Ç–µ–π–Ω—ã –¥–ª—è –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞ 3/4" (–ø–∞—Ä–∞)', art: 'FA 7475', brand: 'FAR', price: 1800 }
        }
    },
    pipes: {
        rehau: {
            brand: 'REHAU',
            p16: { name: '–¢—Ä—É–±–∞ RAUTITAN Flex 16,2—Ö2,6–º–º (–±—É—Ö—Ç–∞ 100–º)', art: '130121-100', brand: 'REHAU', price: 210 },
            p20: { name: '–¢—Ä—É–±–∞ RAUTITAN Flex 20—Ö2,9–º–º (–±—É—Ö—Ç–∞ 100–º)', art: '130131-100', brand: 'REHAU', price: 290 },
            p25: { name: '–¢—Ä—É–±–∞ RAUTITAN Flex 25—Ö3,5–º–º (–±—É—Ö—Ç–∞ 50–º)', art: '11303811001', brand: 'REHAU', price: 480 },
            f16: { name: '–†–µ–∑—å–±–æ–∑–∞–∂–∏–º–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ Flex 16-G1/2 (–ï–≤—Ä–æ–∫–æ–Ω—É—Å)', art: '139551-002', brand: 'REHAU', price: 650 },
            f20: { name: '–†–µ–∑—å–±–æ–∑–∞–∂–∏–º–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ Flex 20-G1/2 (–ï–≤—Ä–æ–∫–æ–Ω—É—Å)', art: '139561-002', brand: 'REHAU', price: 780 },
            s16: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π 16-1/2" Rp (–∫–æ—Ä–æ—Ç–∫–∏–π)', art: '11096631001', brand: 'REHAU', price: 1100 },
            s20: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π 20-1/2" Rp (–∫–æ—Ä–æ—Ç–∫–∏–π)', art: '11096781001', brand: 'REHAU', price: 1450 },
            sInst: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π –¥–ª—è –≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω–∞ 16-1/2" (–¥–ª–∏–Ω–Ω—ã–π)', art: '14563533001', brand: 'REHAU', price: 1650 },
            tee25_20: { name: '–¢—Ä–æ–π–Ω–∏–∫ —Ä–∞–≤–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π PX 25-20-25', art: '11080321001', brand: 'REHAU', price: 1800 },
            tee25_25: { name: '–¢—Ä–æ–π–Ω–∏–∫ —Ä–∞–≤–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π PX 25-25-25', art: '11080331001', brand: 'REHAU', price: 1950 },
            sl16: { name: '–ì–∏–ª—å–∑–∞ –Ω–∞–¥–≤–∏–∂–Ω–∞—è PX 16', art: '11600011001', brand: 'REHAU', price: 120 },
            sl20: { name: '–ì–∏–ª—å–∑–∞ –Ω–∞–¥–≤–∏–∂–Ω–∞—è PX 20', art: '11600021001', brand: 'REHAU', price: 150 },
            sl25: { name: '–ì–∏–ª—å–∑–∞ –Ω–∞–¥–≤–∏–∂–Ω–∞—è PX 25', art: '11600031001', brand: 'REHAU', price: 250 },
            boilerF: { name: '–ü–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–µ–∑—å–±–æ–π PX 20-1/2"', art: '13660681001', brand: 'REHAU', price: 950 },
            boilerN: { name: '–ü–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫ —Å –Ω–∞–∫–∏–¥–Ω–æ–π –≥–∞–π–∫–æ–π PX 20-3/4"', art: '14563383001', brand: 'REHAU', price: 1250 },
            bracket: { name: '–ü–ª–∞–Ω–∫–∞ –º–æ–Ω—Ç–∞–∂–Ω–∞—è 75/150 –¥–ª—è –≤–æ–¥–æ—Ä–æ–∑–µ—Ç–æ–∫', art: '11055293008', brand: 'REHAU', price: 650 }
        },
        stout: {
            brand: 'STOUT',
            p16: { name: '–¢—Ä—É–±–∞ PEX-a 16—Ö2.2 —Å–µ—Ä–∞—è (–±—É—Ö—Ç–∞)', art: 'SPX-0002-001622', brand: 'STOUT', price: 95 },
            p20: { name: '–¢—Ä—É–±–∞ PEX-a 20—Ö2.8 —Å–µ—Ä–∞—è (–±—É—Ö—Ç–∞)', art: 'SPX-0002-002028', brand: 'STOUT', price: 140 },
            p25: { name: '–¢—Ä—É–±–∞ PEX-a 25—Ö3.5 —Å–µ—Ä–∞—è (–±—É—Ö—Ç–∞)', art: 'SPX-0002-002535', brand: 'STOUT', price: 220 },
            f16: { name: '–§–∏—Ç–∏–Ω–≥ –∫–æ–º–ø—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π (–ï–≤—Ä–æ–∫–æ–Ω—É—Å) 16-1/2"', art: 'SFA-0020-001612', brand: 'STOUT', price: 350 },
            f20: { name: '–§–∏—Ç–∏–Ω–≥ –∫–æ–º–ø—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π (–ï–≤—Ä–æ–∫–æ–Ω—É—Å) 20-1/2"', art: 'SFA-0020-002012', brand: 'STOUT', price: 420 },
            s16: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π –∞–∫—Å–∏–∞–ª—å–Ω—ã–π 16-1/2" –í–†', art: 'SFA-0026-001612', brand: 'STOUT', price: 550 },
            s20: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π –∞–∫—Å–∏–∞–ª—å–Ω—ã–π 20-1/2" –í–†', art: 'SFA-0026-002012', brand: 'STOUT', price: 720 },
            sInst: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π —É–¥–ª–∏–Ω–µ–Ω–Ω—ã–π 16-1/2"', art: 'SFA-0027-001612', brand: 'STOUT', price: 850 },
            tee25_20: { name: '–¢—Ä–æ–π–Ω–∏–∫ –∞–∫—Å–∏–∞–ª—å–Ω—ã–π 25-20-25', art: 'SFA-0004-252025', brand: 'STOUT', price: 890 },
            tee25_25: { name: '–¢—Ä–æ–π–Ω–∏–∫ –∞–∫—Å–∏–∞–ª—å–Ω—ã–π 25-25-25', art: 'SFA-0004-002525', brand: 'STOUT', price: 950 },
            sl16: { name: '–ì–∏–ª—å–∑–∞ –º–æ–Ω—Ç–∞–∂–Ω–∞—è –∞–∫—Å–∏–∞–ª—å–Ω–∞—è 16', art: 'SFA-0001-000016', brand: 'STOUT', price: 45 },
            sl20: { name: '–ì–∏–ª—å–∑–∞ –º–æ–Ω—Ç–∞–∂–Ω–∞—è –∞–∫—Å–∏–∞–ª—å–Ω–∞—è 20', art: 'SFA-0001-000020', brand: 'STOUT', price: 65 },
            sl25: { name: '–ì–∏–ª—å–∑–∞ –º–æ–Ω—Ç–∞–∂–Ω–∞—è –∞–∫—Å–∏–∞–ª—å–Ω–∞—è 25', art: 'SFA-0001-000025', brand: 'STOUT', price: 95 },
            boilerF: { name: '–ú—É—Ñ—Ç–∞ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–µ–∑—å–±–æ–π 20-1/2"', art: 'SFA-0013-002012', brand: 'STOUT', price: 480 },
            boilerN: { name: '–ú—É—Ñ—Ç–∞ —Å –Ω–∞–∫–∏–¥–Ω–æ–π –≥–∞–π–∫–æ–π 20-3/4"', art: 'SFA-0016-002034', brand: 'STOUT', price: 650 },
            bracket: { name: '–ü–ª–∞–Ω–∫–∞ –º–æ–Ω—Ç–∞–∂–Ω–∞—è –¥–ª—è –≤–æ–¥–æ—Ä–æ–∑–µ—Ç–æ–∫', art: 'SMB-0001-000000', brand: 'STOUT', price: 350 }
        },
        tece: {
            brand: 'TECE',
            p16: { name: '–¢—Ä—É–±–∞ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è TECEflex 16 (PE-Xc/Al/PE)', art: '702016', brand: 'TECE', price: 230 },
            p20: { name: '–¢—Ä—É–±–∞ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è TECEflex 20 (PE-Xc/Al/PE)', art: '702020', brand: 'TECE', price: 320 },
            p25: { name: '–¢—Ä—É–±–∞ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è TECEflex 25 (PE-Xc/Al/PE)', art: '702025', brand: 'TECE', price: 550 },
            f16: { name: '–ê–¥–∞–ø—Ç–µ—Ä –∫–æ–º–ø—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π TECEflex 16-3/4" –ï–≤—Ä–æ–∫–æ–Ω—É—Å', art: '713516', brand: 'TECE', price: 720 },
            f20: { name: '–ê–¥–∞–ø—Ç–µ—Ä –∫–æ–º–ø—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π TECEflex 20-3/4" –ï–≤—Ä–æ–∫–æ–Ω—É—Å', art: '713020', brand: 'TECE', price: 850 },
            s16: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π TECEflex 16-1/2" –í–†', art: '708501', brand: 'TECE', price: 1150 },
            s20: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π TECEflex 20-1/2" –í–†', art: '708502', brand: 'TECE', price: 1550 },
            sInst: { name: '–£–≥–æ–ª—å–Ω–∏–∫ –Ω–∞—Å—Ç–µ–Ω–Ω—ã–π –¥–ª–∏–Ω–Ω—ã–π TECEflex 16-1/2"', art: '708510', brand: 'TECE', price: 1750 },
            tee25_20: { name: '–¢—Ä–æ–π–Ω–∏–∫ –ª–∞—Ç—É–Ω–Ω—ã–π TECEflex 25-20-25', art: '710508', brand: 'TECE', price: 2100 },
            tee25_25: { name: '–¢—Ä–æ–π–Ω–∏–∫ –ª–∞—Ç—É–Ω–Ω—ã–π TECEflex 25-25-25', art: '710509', brand: 'TECE', price: 2300 },
            sl16: { name: '–ü—Ä–µ—Å—Å-–≤—Ç—É–ª–∫–∞ TECEflex 16', art: '734516', brand: 'TECE', price: 130 },
            sl20: { name: '–ü—Ä–µ—Å—Å-–≤—Ç—É–ª–∫–∞ TECEflex 20', art: '734520', brand: 'TECE', price: 160 },
            sl25: { name: '–ü—Ä–µ—Å—Å-–≤—Ç—É–ª–∫–∞ TECEflex 25', art: '734525', brand: 'TECE', price: 280 },
            boilerF: { name: '–ú—É—Ñ—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–Ω–∞—è TECEflex 20-1/2" –í–†', art: '706503', brand: 'TECE', price: 1100 },
            boilerN: { name: '–ú—É—Ñ—Ç–∞ —Å –Ω–∞–∫–∏–¥–Ω–æ–π –≥–∞–π–∫–æ–π TECEflex 20-3/4"', art: '706006', brand: 'TECE', price: 1450 },
            bracket: { name: '–ö—Ä–æ–Ω—à—Ç–µ–π–Ω –º–æ–Ω—Ç–∞–∂–Ω—ã–π (–ø–ª–∞–Ω–∫–∞) 150–º–º', art: '720526', brand: 'TECE', price: 800 }
        }
    },
    insulation: {
        i16: { name: '–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å –¥–ª—è —Ç—Ä—É–± 16,2—Ö2,6–º–º, S=9–º–º, (18/9-2)', art: 'EFXT018092SUPR', brand: 'Energoflex', unit: '–ø.–º.', price: 65 },
        i20: { name: '–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å –¥–ª—è —Ç—Ä—É–± 20—Ö2,9–º–º, S=9–º–º, (22/9-2)', art: 'EFXT022092SUPR', brand: 'Energoflex', unit: '–ø.–º.', price: 75 },
        i25: { name: '–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å –¥–ª—è —Ç—Ä—É–± 25—Ö3,5–º–º, S=9–º–º, (28/9-2)', art: 'EFXT028092SUPR', brand: 'Energoflex', unit: '–ø.–º.', price: 95 }
    },
    common: {
        meter: { name: '–í–æ–¥–æ—Å—á–µ—Ç—á–∏–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–º–ø—É–ª—å—Å–Ω—ã–π 1/2" VLF-15U-I', art: 'VLF-15U-I', brand: 'VALTEC', price: 1400 },
        neptun: { name: '–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã Neptun Smart+ (2 –∫—Ä–∞–Ω–∞ 1/2", 3 –¥–∞—Ç—á–∏–∫–∞)', art: 'Neptun Smart', brand: '–¢–µ–ø–ª–æ–ª—é–∫—Å', price: 28500 },
        viking: { name: '–§–∏–ª—å—Ç—Ä –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π –ê–∫–≤–∞—Ñ–æ—Ä –í–∏–∫–∏–Ω–≥ 300 (–∫–æ—Ä–ø—É—Å, –Ω–µ—Ä–∂. —Å—Ç–∞–ª—å)', art: 'Viking 300', brand: '–ê–∫–≤–∞—Ñ–æ—Ä', price: 14500 },
        vikingCartCold: { name: '–°–º–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è —Ö–æ–ª–æ–¥–Ω–æ–π –≤–æ–¥—ã', art: 'B520-13', brand: '–ê–∫–≤–∞—Ñ–æ—Ä', price: 4200 },
        vikingCartHot: { name: '–°–º–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –≥–æ—Ä—è—á–µ–π –≤–æ–¥—ã', art: 'B520-14', brand: '–ê–∫–≤–∞—Ñ–æ—Ä', price: 4800 },
        fireCabinet: { name: '–®–∫–∞—Ñ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –ø–æ–∂–∞—Ä–æ—Ç—É—à–µ–Ω–∏—è —Å —à–ª–∞–Ω–≥–æ–º (15 –º), –ö–ü–ö-01/2', art: '–ö–ü–ö-01/2', brand: '–ù–ü–û "–ü—É–ª—å—Å"', unit: '–∫–æ–º–ø–ª.', price: 4500 },
        p50: { name: '–¢—Ä—É–±–∞ HTEM 50 –º–º (–ø–æ–ª–∏–ø—Ä–æ–ø–∏–ª–µ–Ω)', art: '112040', brand: 'Ostendorf', unit: '–º', price: 180 },
        p110: { name: '–¢—Ä—É–±–∞ HTEM 110 –º–º (–ø–æ–ª–∏–ø—Ä–æ–ø–∏–ª–µ–Ω)', art: '115040', brand: 'Ostendorf', unit: '–º', price: 450 },
        el50_87: { name: '–û—Ç–≤–æ–¥ HTB 87¬∞ DN 50', art: '112140', brand: 'Ostendorf', price: 85 },
        el50_45: { name: '–û—Ç–≤–æ–¥ HTB 45¬∞ DN 50', art: '112120', brand: 'Ostendorf', price: 85 },
        tee50: { name: '–¢—Ä–æ–π–Ω–∏–∫ HTEA 50/50/45¬∞', art: '112200', brand: 'Ostendorf', price: 150 },
        el110_45: { name: '–û—Ç–≤–æ–¥ HTB 45¬∞ DN 110', art: '115120', brand: 'Ostendorf', price: 220 },
        tee110_50: { name: '–¢—Ä–æ–π–Ω–∏–∫ HTEA 110/50/45¬∞', art: '115220', brand: 'Ostendorf', price: 350 },
        tee110: { name: '–¢—Ä–æ–π–Ω–∏–∫ HTEA 110/110/87¬∞', art: '115400', brand: 'Ostendorf', price: 380 },
        trans: { name: '–†–µ–¥—É–∫—Ü–∏—è HTR 110/50', art: '115710', brand: 'Ostendorf', price: 110 },
        trap: { name: '–¢—Ä–∞–ø HL510N DN50 —Å —Å—É—Ö–∏–º –∑–∞—Ç–≤–æ—Ä–æ–º HL510NHL', art: 'HL510N', brand: 'HL', price: 4500 },
        wm_valve: { name: '–ö—Ä–∞–Ω –¥–ª—è —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã —É–≥–ª–æ–≤–æ–π 1/2"—Ö3/4"', art: 'VT.252.N.0405', brand: 'VALTEC', price: 550 },
        wm_siphon: { name: '–°–∏—Ñ–æ–Ω –¥–ª—è –°–ú/–ü–ú–ú —Å–∫—Ä—ã—Ç–æ–≥–æ –º–æ–Ω—Ç–∞–∂–∞', art: 'HL400', brand: 'HL', price: 2100 },
        plug: { name: '–ó–∞–≥–ª—É—à–∫–∞ –æ–ø—Ä–µ—Å—Å–æ–≤–æ—á–Ω–∞—è 1/2" (–°–∏–Ω+–ö—Ä)', art: 'VTp.792.M.04', brand: 'VALTEC', price: 35 },
        sleeveB: { name: '–í—Ç—É–ª–∫–∞ –∑–∞—â–∏—Ç–Ω–∞—è –°–∏–Ω—è—è (—É–ø–∞–∫)', art: 'VT.VZT.16.B', brand: 'VALTEC', price: 450 },
        sleeveR: { name: '–í—Ç—É–ª–∫–∞ –∑–∞—â–∏—Ç–Ω–∞—è –ö—Ä–∞—Å–Ω–∞—è (—É–ø–∞–∫)', art: 'VT.VZT.16.R', brand: 'VALTEC', price: 450 },
        hose: { name: '–ì–∏–±–∫–∞—è –ø–æ–¥–≤–æ–¥–∫–∞ 1/2" 40—Å–º (–≥–∞–π–∫–∞-–≥–∞–π–∫–∞)', art: 'STOUT-400', brand: 'STOUT', price: 450 }
    }
};

const App = {
    state: {
        bathrooms: [],
        config: {
            sysType: 'door',
            inletDia: '20',
            inletCount: 1,
            brandValve: 'valtec',
            brandPipe: 'rehau',
            components: {
                valve: true, neptun: true, mud: true, meter: true, 
                check: true, fine: true, red: true, viking: false, 
                fire: false, 
                trap_global: false
            }
        }
    },

    init() {
        this.onSystemChange(); 
        this.updateBathCount(); 
    },

    onSystemChange() {
        const type = document.getElementById('sysType').value;
        const sel = document.getElementById('inletDia');
        sel.innerHTML = '';
        if (type === 'riser') {
            sel.add(new Option('15 –º–º (1/2")', '15'));
            sel.value = '15'; 
        } else {
            sel.add(new Option('20 –º–º (3/4")', '20'));
            sel.add(new Option('25 –º–º (1")', '25'));
            sel.value = '20';
        }
        this.update();
    },

    updateBathCount() {
        const count = parseInt(document.getElementById('bathCount').value);
        if (this.state.bathrooms.length < count) {
            for (let i = this.state.bathrooms.length; i < count; i++) {
                this.state.bathrooms.push({
                    id: i,
                    dev: { inst: 1, wash: 1, bath: 1, shower: 0, kitchen: 0, appliances: 1 },
                    dist: 5,
                    boiler: false
                });
            }
        } else {
            this.state.bathrooms = this.state.bathrooms.slice(0, count);
        }
        this.renderBathUI();
        this.update();
    },

    renderBathUI() {
        const c = document.getElementById('bathContainer');
        c.innerHTML = '';
        this.state.bathrooms.forEach((b, idx) => {
            const el = document.createElement('div');
            el.className = 'bath-card';
            el.innerHTML = `
                <div class="bath-header">
                    <span>–°–∞–Ω—É–∑–µ–ª ‚Ññ${idx+1}</span>
                    <span>L = <input type="number" value="${b.dist}" onchange="App.setBathProp(${idx}, 'dist', this.value)" style="width:40px"> –º</span>
                </div>
                <div class="device-group">
                    <div class="device-item"><label>üöΩ –ò–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è</label> <input type="number" value="${b.dev.inst}" min="0" onchange="App.setDev(${idx}, 'inst', this.value)"></div>
                    <div class="device-item"><label>üö∞ –£–º—ã–≤–∞–ª—å–Ω–∏–∫</label> <input type="number" value="${b.dev.wash}" min="0" onchange="App.setDev(${idx}, 'wash', this.value)"></div>
                    <div class="device-item"><label>üõÅ –í–∞–Ω–Ω–∞</label> <input type="number" value="${b.dev.bath}" min="0" onchange="App.setDev(${idx}, 'bath', this.value)"></div>
                    <div class="device-item"><label>üöø –î—É—à</label> <input type="number" value="${b.dev.shower}" min="0" onchange="App.setDev(${idx}, 'shower', this.value)"></div>
                    <div class="device-item"><label>üçΩ –ö—É—Ö. –º–æ–π–∫–∞</label> <input type="number" value="${b.dev.kitchen}" min="0" onchange="App.setDev(${idx}, 'kitchen', this.value)"></div>
                    <div class="device-item"><label>üîå –°–ú / –ü–ú–ú</label> <input type="number" value="${b.dev.appliances}" min="0" onchange="App.setDev(${idx}, 'appliances', this.value)"></div>
                    <div class="device-item" style="margin-top:5px; background:none; border:none;">
                        <label><input type="checkbox" ${b.boiler ? 'checked' : ''} onchange="App.setBathProp(${idx}, 'boiler', this.checked)"> üî• –í–æ–¥–æ–Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å</label>
                    </div>
                </div>
            `;
            c.appendChild(el);
        });
    },

    setBathProp(idx, prop, val) {
        if(prop === 'dist') this.state.bathrooms[idx].dist = parseFloat(val);
        if(prop === 'boiler') this.state.bathrooms[idx].boiler = val;
        this.update();
    },
    setDev(idx, type, val) {
        this.state.bathrooms[idx].dev[type] = parseInt(val);
        this.update();
    },

    readConfig() {
        this.state.config.sysType = document.getElementById('sysType').value;
        this.state.config.inletDia = document.getElementById('inletDia').value;
        this.state.config.inletCount = parseInt(document.getElementById('inletCount').value);
        this.state.config.brandValve = document.getElementById('brandValve').value;
        this.state.config.brandPipe = document.getElementById('brandPipe').value;
        const c = this.state.config.components;
        c.valve = document.getElementById('comp_valve').checked;
        c.neptun = document.getElementById('comp_neptun').checked;
        c.mud = document.getElementById('comp_mud').checked;
        c.meter = document.getElementById('comp_meter').checked;
        c.check = document.getElementById('comp_check').checked;
        c.fine = document.getElementById('comp_fine').checked;
        c.red = document.getElementById('comp_red').checked;
        c.viking = document.getElementById('comp_viking').checked;
        c.fire = document.getElementById('comp_fire').checked; 
        c.trap_global = document.getElementById('comp_trap_global').checked;
    },

    update() {
        this.readConfig();
        const cfg = this.state.config;
        const spec = [];
        const add = (obj, qty, note='') => {
            if(!obj || qty <= 0) return;
            const exist = spec.find(i => i.art === obj.art && i.type !== 'header');
            if(exist) {
                exist.qty += qty;
                if(note && !exist.note.includes(note)) exist.note += `, ${note}`;
            } else {
                spec.push({...obj, qty: qty, note: note});
            }
        };
        const header = (name) => spec.push({type:'header', name});
        const B_VALVE = DB.armature[cfg.brandValve];
        const B_PIPE = DB.pipes[cfg.brandPipe];

        header(`1. –£–∑–µ–ª –≤–≤–æ–¥–∞ –∏ —É—á–µ—Ç–∞ (${cfg.brandValve.toUpperCase()})`);
        const pairs = cfg.inletCount; 
        const lines = pairs * 2; 
        if(cfg.components.valve) add(B_VALVE.valve, lines, '–í–≤–æ–¥–Ω–æ–π –∫—Ä–∞–Ω');
        if(cfg.components.neptun) add(DB.common.neptun, pairs, '1 –∫–æ–º–ø–ª. –Ω–∞ —Å—Ç–æ—è–∫');
        if(cfg.components.mud) add(B_VALVE.mud, lines);
        if(cfg.components.meter) add(DB.common.meter, lines); 
        if(cfg.components.fine) add(B_VALVE.fine, lines);
        if(cfg.components.red) add(B_VALVE.red, lines);
        if(cfg.components.check) add(B_VALVE.check, lines);
        if(cfg.components.viking) {
            add(DB.common.viking, lines, '–ö–æ—Ä–ø—É—Å 300–º–º');
            add(DB.common.vikingCartCold, pairs, '–•–í–°');
            add(DB.common.vikingCartHot, pairs, '–ì–í–°');
        }
        const bathsCount = this.state.bathrooms.length;
        add(B_VALVE.elbowMale, bathsCount * 2, '–í—Ö–æ–¥ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞'); 

        header('2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã');
        add(B_VALVE.bracket, bathsCount, '–ü–∞—Ä–∞ –Ω–∞ —à–∫–∞—Ñ');
        this.state.bathrooms.forEach(b => {
            const prefix = `–°–£${b.id+1}`;
            let hws = b.dev.wash + b.dev.kitchen + b.dev.shower + b.dev.bath + (b.boiler ? 1 : 0);
            let cws = hws + b.dev.inst + b.dev.appliances;
            this.calcCollector(hws, B_VALVE, add, prefix+' –ì–í–°');
            this.calcCollector(cws, B_VALVE, add, prefix+' –•–í–°');
        });

        header(`3. –¢—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (${cfg.brandPipe.toUpperCase()})`);
        let len16 = 0, len20 = 0, len25 = 0;
        let sleeve16 = 0, sleeve20 = 0, sleeve25 = 0;
        if(cfg.inletDia === '25') {
            const totalDist = this.state.bathrooms.reduce((sum, b) => sum + b.dist, 0);
            len25 += totalDist * 2; 
            if(bathsCount > 1) {
                const splits = (bathsCount - 1) * 2; 
                add(B_PIPE.tee25_20, splits, '–†–∞–∑–≤–µ—Ç–≤–ª–µ–Ω–∏–µ –Ω–∞ –°–£');
                sleeve25 += splits * 2; 
                sleeve20 += splits; 
            }
        }
        const totalWash = this.state.bathrooms.reduce((sum, b) => sum + b.dev.wash, 0);
        if(totalWash > 0) add(DB.common.hose, totalWash * 2, '–ö —Å–º–µ—Å–∏—Ç–µ–ª—è–º —É–º—ã–≤–∞–ª—å–Ω–∏–∫–æ–≤');
        this.state.bathrooms.forEach(b => {
            const note = `–°–£${b.id+1}`;
            const dev = b.dev;
            const pts20 = dev.bath + dev.shower;
            if(pts20 > 0) {
                len20 += pts20 * (b.dist + 2.5);
                add(B_PIPE.s20, pts20, note); 
                add(B_PIPE.f20, pts20, note); 
                sleeve20 += pts20 * 2;
            }
            const pts16 = dev.wash + dev.kitchen + dev.appliances;
            const ptsInst = dev.inst;
            if((pts16 + ptsInst) > 0) {
                len16 += (pts16 + ptsInst) * (b.dist + 2.5);
                if(dev.wash + dev.kitchen > 0) add(B_PIPE.s16, dev.wash + dev.kitchen, note);
                if(dev.appliances > 0) add(B_PIPE.s16, dev.appliances, note + ' (–ö—Ä–∞–Ω –°–ú)');
                if(ptsInst > 0) add(B_PIPE.sInst, ptsInst, note);
                add(B_PIPE.f16, pts16 + ptsInst, note);
                sleeve16 += (pts16 + ptsInst) * 2;
            }
            if(b.boiler) {
                add(B_VALVE.valveW, 2, '–ë–æ–π–ª–µ—Ä'); 
                add(B_VALVE.elbowFem, 2, '–ë–æ–π–ª–µ—Ä'); 
                add(B_PIPE.boilerF, 2, '–í–†'); 
                add(B_PIPE.boilerN, 2, '–ì–∞–π–∫–∞'); 
                len20 += (b.dist + 2) * 2; 
                sleeve20 += 4;
            } else {
                add(B_VALVE.cap, 2, '–ó–∞–≥–ª—É—à–∫–∏ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞');
            }
            if(dev.appliances > 0) {
                add(DB.common.wm_valve, dev.appliances, note);
                add(DB.common.wm_siphon, dev.appliances, note);
            }
            const mix = dev.wash + dev.bath + dev.shower;
            if(mix > 0) add(B_PIPE.bracket, mix, '–î–ª—è —Å–º–µ—Å–∏—Ç–µ–ª–µ–π');
        });
        if(len25 > 0) add(B_PIPE.p25, Math.ceil(len25), '–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å');
        if(len20 > 0) add(B_PIPE.p20, Math.ceil(len20));
        if(len16 > 0) add(B_PIPE.p16, Math.ceil(len16));
        if(len25 > 0) add(DB.insulation.i25, Math.ceil(len25), '–ù–∞ 25 —Ç—Ä—É–±—É');
        if(len20 > 0) add(DB.insulation.i20, Math.ceil(len20), '–ù–∞ 20 —Ç—Ä—É–±—É');
        if(len16 > 0) add(DB.insulation.i16, Math.ceil(len16), '–ù–∞ 16 —Ç—Ä—É–±—É');
        if(sleeve25 > 0) add(B_PIPE.sl25, sleeve25);
        if(sleeve20 > 0) add(B_PIPE.sl20, sleeve20);
        if(sleeve16 > 0) add(B_PIPE.sl16, sleeve16);

        header('4. –°–∏—Å—Ç–µ–º–∞ –ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (–±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–∏–±–æ—Ä–æ–≤)');
        if(cfg.components.trap_global) add(DB.common.trap, 1, ''); 
        
        let sew50 = 0, sew110 = 0, el50 = 0, el110 = 0, tee50 = 0, tee110 = 0, trans = 0;
        this.state.bathrooms.forEach(b => {
            if(b.dev.inst > 0) { sew110 += b.dev.inst * 2; el110 += b.dev.inst * 2; tee110 += b.dev.inst; }
            const p50 = b.dev.wash + b.dev.kitchen + b.dev.bath + b.dev.shower + b.dev.appliances;
            if(p50 > 0) { sew50 += p50 * 2.5; el50 += p50 * 3; tee50 += p50; trans += 1; tee110 += 1; }
        });
        if(sew110 > 0) add(DB.common.p110, Math.ceil(sew110));
        if(sew50 > 0) add(DB.common.p50, Math.ceil(sew50));
        if(el110 > 0) add(DB.common.el110_45, el110);
        if(el50 > 0) { add(DB.common.el50_87, Math.ceil(el50/3)); add(DB.common.el50_45, Math.ceil(el50*2/3)); }
        if(tee110 > 0) add(DB.common.tee110_50, tee110);
        if(tee50 > 0) add(DB.common.tee50, tee50);
        if(trans > 0) add(DB.common.trans, trans);

        if(cfg.components.fire) { header('5. –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∂–∞—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'); add(DB.common.fireCabinet, 1, '–í —Ç–µ—Ö—à–∫–∞—Ñ—É'); }
        header('6. –†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã');
        const points = sleeve16 + sleeve20 + sleeve25;
        if(points > 0) {
            add(DB.common.plug, Math.ceil(points/4), '–ó–∞–≥–ª—É—à–∫–∏ –æ–ø—Ä–µ—Å—Å–æ–≤–∫–∏');
            add(DB.common.sleeveB, Math.ceil(points/20), '–ù–∞ –∏–∑–æ–ª—è—Ü–∏—é (–ø–∞—á–∫–∞)');
            add(DB.common.sleeveR, Math.ceil(points/20));
        }
        this.renderTable(spec);
        this.currentSpec = spec; 
    },

    calcCollector(ports, brandObj, addFn, note) {
        if(ports <= 0) return;
        let remain = ports;
        while(remain > 0) {
            let p = (remain >= 4) ? 4 : (remain === 3 ? 3 : 2);
            let price = (brandObj.collector.price * p); 
            let art = brandObj.collector.base.includes('VTc') ? `${brandObj.collector.base}.050${p}` : `${brandObj.collector.base} ${p}`;
            let name = `${brandObj.collector.name} ${p} –≤—ã—Ö.`;
            addFn({name, art, brand: brandObj.brand, price: price}, 1, note);
            remain -= p;
        }
    },

    formatMoney(amount) { return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(amount); },

    renderTable(list) {
        const tb = document.getElementById('specBody');
        const tf = document.getElementById('specFoot');
        tb.innerHTML = ''; tf.innerHTML = '';
        let n = 1; let totalSum = 0;
        list.forEach(item => {
            if(item.type === 'header') {
                tb.innerHTML += `<tr class="group-header"><td colspan="9">${item.name}</td></tr>`;
            } else {
                const price = item.price || 0; const sum = price * item.qty; totalSum += sum;
                tb.innerHTML += `
                    <tr>
                        <td class="col-n">${n++}</td>
                        <td>${item.name}</td>
                        <td class="col-code">${item.art}</td>
                        <td class="col-brand">${item.brand || ''}</td>
                        <td class="col-unit">${item.unit || '—à—Ç'}</td>
                        <td class="col-qty">${item.qty}</td>
                        <td class="col-price">${price > 0 ? price.toLocaleString() : '-'}</td>
                        <td class="col-sum">${sum > 0 ? sum.toLocaleString() : '-'}</td>
                        <td class="col-note">${item.note}</td>
                    </tr>
                `;
            }
        });
        tf.innerHTML = `<tr class="total-row"><td colspan="7" style="text-align:right;">–ò–¢–û–ì–û (–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ):</td><td colspan="2" style="background-color: #27ae60;">${this.formatMoney(totalSum)}</td></tr>`;
    },

    exportJSON() {
        const blob = new Blob([JSON.stringify(this.state)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "project_vk_pro_v4.json"; a.click();
    },

    exportExcel() {
        if(!this.currentSpec) return;
        const wb = XLSX.utils.book_new();
        const ws_data = [["–ü–æ–∑–∏—Ü–∏—è", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞", "–ö–æ–¥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è", "–ó–∞–≤–æ–¥-–∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å", "–ï–¥. –∏–∑–º.", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"]];
        let n = 1;
        this.currentSpec.forEach(i => {
            if(i.type === 'header') ws_data.push(["", i.name.toUpperCase(), "", "", "", "", ""]);
            else ws_data.push([n++, i.name, i.art, i.brand || '', i.unit || '—à—Ç', i.qty, i.note]);
        });
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws['!cols'] = [{wch:8}, {wch:70}, {wch:20}, {wch:15}, {wch:8}, {wch:12}, {wch:25}];
        XLSX.utils.book_append_sheet(wb, ws, "–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([[JSON.stringify(this.state)]]), "PROJECT_DATA");
        XLSX.writeFile(wb, "Spec_Pro_VK_Ultimate.xlsx");
    },

    importProject(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        if(file.name.endsWith('.json')) {
            reader.onload = (e) => { this.state = JSON.parse(e.target.result); this.refreshUIfromState(); };
            reader.readAsText(file);
        } else {
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                if(wb.SheetNames.includes("PROJECT_DATA")) {
                    this.state = JSON.parse(wb.Sheets["PROJECT_DATA"]['A1'].v);
                    this.refreshUIfromState();
                }
            };
            reader.readAsArrayBuffer(file);
        }
    },

    refreshUIfromState() {
        const c = this.state.config;
        document.getElementById('sysType').value = c.sysType; this.onSystemChange(); 
        document.getElementById('inletDia').value = c.inletDia;
        document.getElementById('inletCount').value = c.inletCount;
        document.getElementById('brandValve').value = c.brandValve;
        document.getElementById('brandPipe').value = c.brandPipe;
        document.getElementById('bathCount').value = this.state.bathrooms.length;
        document.getElementById('comp_valve').checked = c.components.valve;
        document.getElementById('comp_neptun').checked = c.components.neptun;
        document.getElementById('comp_mud').checked = c.components.mud;
        document.getElementById('comp_meter').checked = c.components.meter;
        document.getElementById('comp_check').checked = c.components.check;
        document.getElementById('comp_fine').checked = c.components.fine;
        document.getElementById('comp_red').checked = c.components.red;
        document.getElementById('comp_viking').checked = c.components.viking;
        if(c.components.fire !== undefined) document.getElementById('comp_fire').checked = c.components.fire;
        document.getElementById('comp_trap_global').checked = c.components.trap_global;
        this.renderBathUI(); this.update();
    }
};

document.addEventListener("DOMContentLoaded", () => App.init());
</script>
</body>
</html>