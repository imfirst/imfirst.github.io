<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shield Expert ULTIMATE v17.15 PRO</title>
    <style>
        :root { --brand-c: #ff0000; --din-w: 42px; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin:0; padding: 20px; color: #1a202c; }
        .container { max-width: 1900px; margin: 0 auto; display: grid; grid-template-columns: 420px 1fr; gap: 25px; }
        .sidebar { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; height: fit-content; }
        @media (min-width: 1301px) { .sidebar { position: sticky; top: 10px; max-height: 95vh; overflow-y: auto; } }
        @media (max-width: 1300px) { .container { grid-template-columns: 1fr; } .sidebar { position: relative; } .info-bar { flex-direction: column; gap: 10px !important; } }
        .group-title { background: #1a202c; color: white; padding: 10px; font-size: 11px; font-weight: 800; border-radius: 4px; text-transform: uppercase; margin-bottom: 15px; }
        label { display: block; font-size: 10px; font-weight: 800; color: #64748b; margin-bottom: 4px; text-transform: uppercase; text-align: left; }
        select, input { width: 100%; padding: 10px; margin-bottom: 12px; border: 2px solid #edf2f7; border-radius: 8px; font-size: 14px; font-weight: 600; box-sizing: border-box; }
        .chk-group { display: flex; align-items: center; justify-content: flex-start; gap: 12px; font-size: 13px; font-weight: 700; margin-bottom: 10px; cursor: pointer; }
        .chk-group input { width: auto; margin: 0; transform: scale(1.3); }
        .cust-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 8px; border-radius: 6px; margin-bottom: 5px; border: 1px solid #e2e8f0; font-size: 12px; font-weight: 700; }
        .btn-del { background: #ff0000; color: white; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; }
        .shield-frame { background: #cbd5e0; border: 15px solid #2d3748; padding: 30px; border-radius: 8px; display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 100%; overflow-x: auto; }
        .rail-wrap { margin-bottom: 30px; }
        .rail { background: #94a3b8; display: grid; grid-template-columns: repeat(var(--r-mod), var(--din-w)); gap: 1px; padding: 5px; border-top: 10px solid #1a202c; border-bottom: 4px solid #1a202c; width: fit-content; min-height: 112px; }
        .mod { background: white; border: 1px solid #000; height: 110px; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; box-sizing: border-box; cursor: grab; position: relative; user-select: none; }
        .mod.dragging { opacity: 0.2; background: #cbd5e0; }
        .w1 { grid-column: span 1; } .w2 { grid-column: span 2; } .w3 { grid-column: span 3; } .w4 { grid-column: span 4; }
        .mod-name { font-size: 9px; font-weight: 900; height: 40px; text-align: center; display: flex; align-items: center; justify-content: center; text-transform: uppercase; outline: none; }
        .mod-spec { font-size: 8px; background: #f8fafc; font-family: monospace; text-align: center; border-top: 1px solid #eee; padding: 2px; outline: none; }
        .mod-ph { font-size: 9px; font-weight: 900; text-align: center; border-top: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .mod-ph:hover { background: #e2e8f0; }
        .L1 { border-bottom: 6px solid #f56565; } .L2 { border-bottom: 6px solid #ed8936; } .L3 { border-bottom: 6px solid #48bb78; } .L123 { border-bottom: 6px solid #1a202c; }
        .btn-main { background: #48bb78; color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: 900; cursor: pointer; text-transform: uppercase; margin-bottom: 8px; }
        .btn-sec { background: #4a5568; }
        .info-bar { background: #1a202c; color: white; padding: 12px 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .info-group { display: flex; align-items: center; gap: 15px; }
        .stat-item { font-size: 13px; white-space: nowrap; }
        .stat-item span { color: #a0aec0; font-size: 10px; text-transform: uppercase; margin-right: 5px; }
        .stat-item b { color: #48bb78; }
        .stat-phase { font-size: 12px; padding: 3px 8px; background: #2d3748; border-radius: 4px; border: 1px solid #4a5568; }
        .stat-phase b { color: white; }
        .warn-balance { border-color: #f56565; background: #742a2a; }
        .spec-table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; }
        .spec-table th, .spec-table td { border: 1px solid #e2e8f0; padding: 12px; font-size: 13px; text-align: left; }
        .spec-table th { background: #1a202c; color: white; }
        .total-row td { background: #edf2f7; font-weight: 900; font-size: 15px; text-align: right; }
        .btn-auto { background: #3182ce; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        @media print { .sidebar, .btn-main, .btn-auto { display: none !important; } .shield-frame { border: 2px solid #000; zoom: 0.8; } }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="section">
            <div class="group-title">1. Сеть и Ввод</div>
            <label>Бренд</label>
            <select id="brand" onchange="gen()">
                <option value="abb" selected>ABB (S200 / ESB)</option>
                <option value="iek">IEK (ВА47 / МКИ)</option>
                <option value="dekraft">Dekraft (ВА-101 / КМ-103)</option>
                <option value="chint">CHINT (DZ47 / NCH8)</option>
            </select>
            <label>Фазы</label>
            <select id="net" onchange="updateDynamic(); gen();">
                <option value="3" selected>3 Фазы (380В)</option>
                <option value="1">1 Фаза (220В)</option>
            </select>
            <label>Вводной аппарат</label>
            <select id="inType" onchange="gen()">
                <option value="av" selected>Автомат (ВА)</option>
                <option value="sw">Рубильник (ВН)</option>
            </select>
            <label>Номинал (А)</label>
            <select id="inAmp" onchange="gen()">
                <option value="25" selected>25А</option>
                <option value="32">32А</option>
                <option value="40">40А</option>
                <option value="50">50А</option>
                <option value="63">63А</option>
            </select>
        </div>

        <div class="section">
            <div class="group-title">2. Защита и Нагрев</div>
            <label class="chk-group"><input type="checkbox" id="useRelay" checked onchange="gen()"> Реле напряжения</label>
            <label class="chk-group"><input type="checkbox" id="useKM" checked onchange="gen()"> Контактор (Мастер-свет)</label>
            <label>Водонагреватель</label>
            <select id="heater" onchange="gen()"></select>
            <label class="chk-group"><input type="checkbox" id="chkCook" checked onchange="gen()"> Варочная панель</label>
            <label class="chk-group"><input type="checkbox" id="chkOven" checked onchange="gen()"> Духовка (АВДТ)</label>
            <label class="chk-group"><input type="checkbox" id="chkDW" checked onchange="gen()"> Посудомойка (АВДТ)</label>
            <label class="chk-group"><input type="checkbox" id="chkWash" checked onchange="gen()"> Стиралка (АВДТ)</label>
            <label class="chk-group"><input type="checkbox" id="chkDry" checked onchange="gen()"> Сушилка (АВДТ)</label>
            <label class="chk-group"><input type="checkbox" id="chkLeak" checked onchange="gen()"> Протечки (АВДТ)</label>
            <label class="chk-group"><input type="checkbox" id="chkFridge" checked onchange="gen()"> Холодильник (АВДТ)</label>
        </div>

        <div class="section">
            <div class="group-title">3. Групповые линии</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label>Свет</label><input type="number" id="nL" value="3" onchange="gen()"></div>
                <div><label>Розетки</label><input type="number" id="nS" value="5" onchange="gen()"></div>
                <div><label>Т.Пол</label><input type="number" id="nF" value="2" onchange="gen()"></div>
                <div><label>Конд.</label><input type="number" id="nAC" value="2" onchange="gen()"></div>
            </div>
        </div>

        <div class="section">
            <div class="group-title">4. Кастомные</div>
            <input type="text" id="custN" placeholder="Название группы">
            <select id="custT"></select>
            <button class="btn-main" style="background:#3182ce" onclick="addC()">Добавить</button>
            <div id="custBox"></div>
        </div>

        <div class="section">
            <div class="group-title">5. Корпус</div>
            <label>Реек</label><input type="number" id="rCount" value="4" onchange="gen()">
            <label>Модулей в ряд</label>
            <select id="rWidth" onchange="gen()">
                <option value="12" selected>12 модулей</option>
                <option value="18">18 модулей</option>
                <option value="24">24 модуля</option>
            </select>
        </div>

        <button class="btn-main" onclick="gen()">Обновить</button>
        <button class="btn-main btn-sec" onclick="exportCSV()">Скачать CSV</button>
        <button class="btn-main btn-sec" style="background:#718096" onclick="window.print()">Печать PDF</button>
        
        <div class="section" style="border-top: 1px solid #e2e8f0; padding-top: 15px; margin-top: 15px;">
            <button class="btn-main" style="background:#2c5282" onclick="saveJSON()">Сохранить проект</button>
            <button class="btn-main" style="background:#4a5568" onclick="document.getElementById('loadInput').click()">Загрузить проект</button>
            <input type="file" id="loadInput" style="display:none" onchange="loadJSON(this)" accept=".json">
        </div>
    </div>

    <div class="content">
        <div class="info-bar">
            <div class="info-group">
                <div class="stat-item"><span>P установл.</span><b id="pI">0 кВт</b></div>
                <div class="stat-item"><span>P макс</span><b id="pC">0 кВт</b></div>
                <div class="stat-item"><span>Модули</span><b id="mU">0 / 0</b></div>
            </div>
            <div class="info-group" id="balanceBox">
                <div class="stat-phase" id="ph1"><b>L1: 0</b></div>
                <div class="stat-phase" id="ph2"><b>L2: 0</b></div>
                <div class="stat-phase" id="ph3"><b>L3: 0</b></div>
                <button class="btn-auto" onclick="autoBalance()">Автобаланс</button>
            </div>
        </div>
        <div id="shield" class="shield-frame"></div>
        <table class="spec-table">
            <thead><tr><th>Наименование</th><th>Артикул/Модель</th><th>Производитель</th><th>Ед. изм.</th><th>Кол-во</th><th>Цена, руб</th><th>Сумма</th></tr></thead>
            <tbody id="specBody"></tbody>
        </table>
    </div>
</div>

<script>
let customs = [];
const BRANDS = {
    abb: { name:'ABB', c:'#ff0000', m1:'S201 C16', m2:'S202 C16', m3:'S203 C16', d1:'DS201 C16', d3:'DS203NC C16', km:'ESB 63-40', sw1:'SD201', sw2:'SD202', sw3:'SD203', pr: { m1: 650, m2: 1500, m3: 2300, d1: 4500, d3: 8500, km: 5000, sw1: 800, sw2: 1600, sw3: 2500, rn: 3500, bus1: 800, bus3: 1500, shield: 3500 } },
    iek: { name:'IEK', c:'#fbc02d', m1:'ВА47-29', m2:'ВА47-29 2П', m3:'ВА47-100', d1:'АВДТ32', d3:'АВДТ34 C16', km:'МКИ 63А', sw1:'ВН-32', sw2:'ВН-32 2П', sw3:'ВН-32 3П', pr: { m1: 250, m2: 550, m3: 850, d1: 1600, d3: 3200, km: 1800, sw1: 300, sw2: 600, sw3: 900, rn: 2800, bus1: 400, bus3: 900, shield: 1800 } },
    dekraft: { name:'Dekraft', c:'#48bb78', m1:'ВА-101 C16', m2:'ВА-101 2П', m3:'ВА-103 C16', d1:'ДИФ-101 C16', d3:'ДИФ-103 C16', km:'КМ-103 63А', sw1:'ВН-102', sw2:'ВН-102 2П', sw3:'ВН-102 3П', pr: { m1: 220, m2: 500, m3: 800, d1: 1550, d3: 3100, km: 1750, sw1: 290, sw2: 580, sw3: 880, rn: 2800, bus1: 380, bus3: 850, shield: 1750 } },
    chint: { name:'CHINT', c:'#3182ce', m1:'DZ47', m2:'DZ47-2P', m3:'DZ47-60', d1:'NB2LE', d3:'NB2LE-4P', km:'NCH8 63А', sw1:'NH4', sw2:'NH4-2P', sw3:'NH4-3P', pr: { m1: 240, m2: 520, m3: 820, d1: 1500, d3: 3000, km: 1700, sw1: 280, sw2: 550, sw3: 850, rn: 2800, bus1: 350, bus3: 800, shield: 1700 } }
};
const SHIELDS = {
    abb: { 12:'1SLM004101A1203', 24:'1SLM004101A1205', 36:'1SLM004101A1207', 48:'1SLM004101A1208', 72:'1SLM004101A1210' },
    iek: { 12:'MKM14-V-12-31-Z', 24:'MKM14-V-24-31-Z', 36:'MKM14-V-36-31-Z', 48:'MKM14-V-48-31-Z', 72:'MKM14-V-72-31-Z' },
    dekraft: { 12:'30012DEK', 24:'30024DEK', 36:'30036DEK', 48:'30048DEK', 72:'30072DEK' },
    chint: { 12:'NX8-12', 24:'NX8-24', 36:'NX8-36', 48:'NX8-48' }
};

function updateDynamic() {
    const is3 = document.getElementById('net').value === "3";
    const h = document.getElementById('heater');
    const ct = document.getElementById('custT');
    h.innerHTML = `<option value="none">-- Нет --</option><option value="b1">Бойлер 2кВт (1Ф)</option>` + (is3 ? `<option value="p3">Проточник 8кВт (3Ф)</option>` : `<option value="p1">Проточник 6кВт (1Ф)</option>`);
    ct.innerHTML = `<option value="av1">АВ 1Ф</option><option value="dif1">АВДТ 1Ф</option>` + (is3?`<option value="av3">АВ 3Ф</option><option value="dif3">АВДТ 3Ф</option>`:'');
}

function addC() {
    const name = document.getElementById('custN').value || "Новая группа";
    customs.push({ n: name, t: document.getElementById('custT').value, id: Date.now() });
    document.getElementById('custN').value = ""; renderC(); gen();
}
function delC(id) { customs = customs.filter(i => i.id !== id); renderC(); gen(); }
function renderC() {
    document.getElementById('custBox').innerHTML = customs.map(i => `<div class="cust-item"><span>${i.n}</span><button class="btn-del" onclick="delC(${i.id})">×</button></div>`).join('');
}

function updateSpecFromShield() {
    let items = []; let c1P = 0, c3P = 0;
    document.querySelectorAll('.mod:not(.dragging)').forEach(m => {
        const prKey = m.getAttribute('data-price-key');
        const w = parseInt(m.className.match(/w(\d+)/)[1]);
        const d = m.getAttribute('data-desc');
        if(!d.includes("ВВОД") && !d.includes("Реле")) { if(w === 1) c1P++; if(w === 3 || w === 4) c3P++; }
        items.push({ name: m.innerText.split('\n')[0], model: m.getAttribute('data-model'), desc: m.getAttribute('data-desc'), brand: m.getAttribute('data-brand'), price: parseInt(prKey || 0) });
    });

    let summary = {};
    items.forEach(it => {
        const key = `${it.desc}|${it.model}|${it.brand}|${it.price}`;
        if (!summary[key]) summary[key] = { ...it, count: 0 };
        summary[key].count++;
    });

    let finalRows = Object.values(summary);
    const bKey = document.getElementById('brand').value;
    const prices = BRANDS[bKey].pr;
    const rC = parseInt(document.getElementById('rCount').value);
    const rW = parseInt(document.getElementById('rWidth').value);
    const totalMod = rC * rW;
    
    let shArt = SHIELDS[bKey]?.[totalMod] || "Заказной код";
    finalRows.push({ name: "ЩИТ", desc: `Щит распределительный встраиваемый с клеммниками N/PE, IP 41, ${totalMod} мод.`, model: shArt, brand: BRANDS[bKey].name, count: 1, price: prices.shield + (totalMod * 50), isShield: true });

    if(c1P > 2) finalRows.push({ name: "ШИНА 1P", desc: "Шина соединительная (PIN), 1-полюсная, 63А", model: "Busbar 1P", brand: BRANDS[bKey].name, count: Math.ceil(c1P/12), price: prices.bus1, isAcc: true });
    if(c3P > 1) finalRows.push({ name: "ШИНА 3P", desc: "Шина соединительная (PIN), 3-полюсная, 63А", model: "Busbar 3P", brand: BRANDS[bKey].name, count: Math.ceil(c3P/4), price: prices.bus3, isAcc: true });

    finalRows.forEach(row => {
        let weight = 100;
        const ampMatch = row.model.match(/C(\d+)/) || row.model.match(/(\d+)A/);
        let amps = ampMatch ? parseInt(ampMatch[1]) : 0;
        if (row.isShield) weight = 0;
        else if (row.name.includes("ВВОД")) weight = 10;
        else if (row.desc.includes("Реле напряжения")) weight = 20;
        else if (row.desc.includes("3-полюсный") && !row.isAcc) weight = 30;
        else if (row.desc.includes("1-полюсный") && !row.isAcc) weight = 40;
        else if (row.desc.includes("АВДТ") && (row.desc.includes("4-полюсный") || row.model.includes("3NC"))) weight = 50;
        else if (row.desc.includes("АВДТ")) weight = 60;
        else if (row.desc.includes("Контактор")) weight = 70;
        else if (row.isAcc) weight = 90;
        row.sortKey = weight + (amps / 1000);
    });
    finalRows.sort((a, b) => a.sortKey - b.sortKey);

    let totalSum = 0;
    const rowsHtml = finalRows.map(row => {
        const sum = row.count * row.price;
        totalSum += sum;
        return `<tr><td>${row.desc}</td><td>${row.model}</td><td>${row.brand}</td><td>шт.</td><td>${row.count}</td><td>${row.price}</td><td>${sum}</td></tr>`;
    }).join('');
    document.getElementById('specBody').innerHTML = rowsHtml + `<tr class="total-row"><td colspan="6">ИТОГО:</td><td>${totalSum} руб.</td></tr>`;
    updateBalance();
}

function updateBalance() {
    let l1 = 0, l2 = 0, l3 = 0;
    const is3 = document.getElementById('net').value === "3";
    document.querySelectorAll('.mod:not(.dragging)').forEach(m => {
        const p = parseFloat(m.getAttribute('data-p') || 0);
        const ph = Array.from(m.classList).find(c => ["L1", "L2", "L3", "L123"].includes(c));
        if(ph === 'L1') l1 += p;
        else if(ph === 'L2') l2 += p;
        else if(ph === 'L3') l3 += p;
        else if(ph === 'L123') { l1 += p/3; l2 += p/3; l3 += p/3; }
    });
    document.getElementById('ph1').querySelector('b').innerText = `L1: ${l1.toFixed(1)} кВт`;
    document.getElementById('ph2').querySelector('b').innerText = `L2: ${l2.toFixed(1)} кВт`;
    document.getElementById('ph3').querySelector('b').innerText = `L3: ${l3.toFixed(1)} кВт`;
    if(is3) {
        document.getElementById('balanceBox').style.display = 'flex';
        const max = Math.max(l1, l2, l3); const min = Math.min(l1, l2, l3);
        const isBad = (max - min) > (max * 0.2) && max > 2;
        [1,2,3].forEach(i => document.getElementById('ph'+i).classList.toggle('warn-balance', isBad));
    } else document.getElementById('balanceBox').style.display = 'none';
}

function autoBalance() {
    const is3 = document.getElementById('net').value === "3";
    if(!is3) return;
    let items = [];
    document.querySelectorAll('.mod').forEach(m => {
        // Исключаем 3-фазные, РЕЛЕ и ОСВЕЩЕНИЕ из автобаланса
        if(!m.classList.contains('L123') && !m.innerText.includes('РЕЛЕ') && !m.innerText.includes('ОСВ.')) {
            items.push({ el: m, p: parseFloat(m.getAttribute('data-p') || 0) });
        }
    });
    items.sort((a,b) => b.p - a.p);
    let loads = { L1: 0, L2: 0, L3: 0 };
    document.querySelectorAll('.mod').forEach(m => {
        if(m.classList.contains('L123') || m.innerText.includes('РЕЛЕ') || m.innerText.includes('ОСВ.')) {
            const p = parseFloat(m.getAttribute('data-p') || 0);
            const ph = Array.from(m.classList).find(c => ["L1", "L2", "L3"].includes(c));
            if(ph) loads[ph] += p;
            else if(m.classList.contains('L123')) { loads.L1 += p/3; loads.L2 += p/3; loads.L3 += p/3; }
        }
    });
    items.forEach(it => {
        let minPh = Object.keys(loads).reduce((a, b) => loads[a] < loads[b] ? a : b);
        it.el.classList.remove('L1', 'L2', 'L3');
        it.el.classList.add(minPh);
        it.el.querySelector('.mod-ph').innerText = minPh;
        loads[minPh] += it.p;
    });
    updateBalance();
}

function gen() {
    const is3 = document.getElementById('net').value === "3";
    const brandKey = document.getElementById('brand').value;
    const b = BRANDS[brandKey];
    const rC = parseInt(document.getElementById('rCount').value);
    const rW = parseInt(document.getElementById('rWidth').value);
    const inA = document.getElementById('inAmp').value;
    const inType = document.getElementById('inType').value;
    document.getElementById('pC').innerText = (is3 ? (1.732 * 380 * inA * 0.9 / 1000) : (220 * inA * 0.9 / 1000)).toFixed(1) + " кВт";
    document.documentElement.style.setProperty('--r-mod', rW);

    let items = []; let pIdx = 0;
    const getP = () => is3 ? ["L1", "L2", "L3"][pIdx++ % 3] : "L1";

    let inModel = inType === 'sw' ? ((is3 ? b.sw3 : b.sw2) + " " + inA + "A") : (is3 ? b.m3 : b.m2).replace('C16', 'C'+inA);
    let inDesc = inType === 'sw' ? `Выключатель-разъединитель, ${is3?'3':'2'}-полюсный, ${inA}A` : `Выключатель автоматический, ${is3?'3':'2'}-полюсный, ${inA}A, хар-ка «C»`;
    items.push({n: "ВВОД", m: inModel, desc: inDesc, brand: b.name, w: is3?3:2, ph: is3?"L123":"L1", p: 0, pr: is3?b.pr.m3:b.pr.m2});
    
    if(document.getElementById('useRelay').checked) {
        const rnDesc = "Защитное устройство (Реле напряжения), 1-полюсное, 63А";
        if(is3) {
            items.push({ n: "РЕЛЕ L1", m: "RN-263T", desc: rnDesc, brand: "Новатек", w: 2, ph: "L1", p: 0.1, pr: b.pr.rn });
            items.push({ n: "РЕЛЕ L2", m: "RN-263T", desc: rnDesc, brand: "Новатек", w: 2, ph: "L2", p: 0.1, pr: b.pr.rn });
            items.push({ n: "РЕЛЕ L3", m: "RN-263T", desc: rnDesc, brand: "Новатек", w: 2, ph: "L3", p: 0.1, pr: b.pr.rn });
        } else items.push({ n: "РЕЛЕ НАПР.", m: "RN-263T", desc: rnDesc, brand: "Новатек", w: 2, ph: "L1", p: 0.1, pr: b.pr.rn });
    }

    if(document.getElementById('useKM').checked) {
        items.push({ n: "ЗАЩ. КМ", m: b.m1.replace('C16','C2'), desc: "Выключатель автоматический, 1-полюсный, 2A, хар-ка «C»", brand: b.name, w: 1, ph: "L1", p: 0.1, pr: b.pr.m1 });
        items.push({ n: "КОНТАКТОР", m: b.km, desc: "Контактор модульный, катушка 230В, 63А, 4НО", brand: b.name, w: 3, ph: is3?"L123":"L1", p: 0.2, pr: b.pr.km });
    }

    for(let i=1; i<=document.getElementById('nL').value; i++) {
        items.push({ n: "ОСВ. "+i, m: b.m1.replace('C16','C10'), desc: "Выключатель автоматический, 1-полюсный, 10A, хар-ка «C»", brand: b.name, w: 1, ph: getP(), p: 0.2, pr: b.pr.m1 });
    }

    const avdtD = "Выключатель дифференциальный (АВДТ), 2-полюсный, 16A, 30мА, тип AC";
    const ht = document.getElementById('heater').value;
    if(ht==='b1') items.push({n: "БОЙЛЕР", m: b.d1, desc:avdtD, brand: b.name, w: 2, ph: getP(), p: 2.0, pr: b.pr.d1});
    if(ht==='p1') items.push({n: "ПРОТОЧНИК", m: b.d1.replace('C16','C32'), desc:avdtD.replace('16A','32A'), brand: b.name, w: 2, ph: getP(), p: 6.0, pr: b.pr.d1});
    if(ht==='p3') items.push({n: "ПРОТОЧНИК 3Ф", m: b.d3, desc:"Выключатель дифференциальный (АВДТ), 4-полюсный, 16A, 30мА, тип AC", brand: b.name, w: 4, ph: "L123", p: 8.0, pr: b.pr.d3});

    if(document.getElementById('chkCook').checked) items.push({ n: "ВАР. ПАНЕЛЬ", m: is3?b.m3:b.m1, desc: `Выключатель автоматический, ${is3?3:1}-полюсный, 16A, хар-ка «C»`, brand: b.name, w: is3?3:1, ph: is3?"L123":"L1", p: 7.0, pr: is3?b.pr.m3:b.pr.m1 });
    
    const chks = { Oven: "ДУХОВКА", DW: "ПММ", Wash: "СТИРАЛКА", Dry: "СУШИЛКА", Leak: "ПРОТЕЧКИ", Fridge: "ХОЛ-К" };
    const powers = { Oven: 3.0, DW: 2.1, Wash: 2.2, Dry: 2.0, Leak: 0.2, Fridge: 0.5 };
    for (const [key, name] of Object.entries(chks)) {
        if(document.getElementById('chk'+key).checked) items.push({n: name, m: b.d1, desc:avdtD, brand: b.name, w: 2, ph: getP(), p: powers[key], pr: b.pr.d1});
    }

    for(let i=1; i<=document.getElementById('nS').value; i++) items.push({n: "РОЗЕТКИ "+i, m: b.d1, desc:avdtD, brand: b.name, w: 2, ph: getP(), p: 1.5, pr: b.pr.d1});
    for(let i=1; i<=document.getElementById('nF').value; i++) items.push({n: "Т.ПОЛ "+i, m: b.d1, desc:avdtD, brand: b.name, w: 2, ph: getP(), p: 0.8, pr: b.pr.d1});
    for(let i=1; i<=document.getElementById('nAC').value; i++) items.push({n: "КОНД. "+i, m: b.m1, desc:"Выключатель автоматический, 1-полюсный, 16A, хар-ка «C»", brand: b.name, w: 1, ph: getP(), p: 1.5, pr: b.pr.m1});

    customs.forEach(c => {
        let w = c.t.includes('3')?3:1; if(c.t.includes('dif')) w = c.t.includes('3')?4:2;
        let prKey = c.t.includes('dif') ? (c.t.includes('3')?'d3':'d1') : (c.t.includes('3')?'m3':'m1');
        items.push({n: c.n, m: b[prKey], desc: c.t.includes('dif')?avdtD:"Выключатель автоматический, хар-ка «C»", brand: b.name, w, ph: c.t.includes('3')?"L123":getP(), p: 1.0, pr: b.pr[prKey]});
    });

    const space = document.getElementById('shield'); space.innerHTML = "";
    let sumP = 0, sumW = 0;
    for(let r=1; r<=rC; r++) {
        const wrap = document.createElement('div'); wrap.className = "rail-wrap";
        const rail = document.createElement('div'); rail.className = "rail";
        wrap.innerHTML = `<div style="font-size:10px; font-weight:900; margin-bottom:5px;">DIN-РЕЙКА №${r}</div>`;
        let used = 0;
        while(items.length > 0 && used + items[0].w <= rW) {
            let it = items.shift();
            sumP += it.p; sumW += it.w;
            const m = document.createElement('div');
            m.className = `mod w${it.w} ${it.ph}`;
            m.draggable = true;
            m.setAttribute('data-p', it.p); m.setAttribute('data-model', it.m);
            m.setAttribute('data-desc', it.desc); m.setAttribute('data-brand', it.brand); m.setAttribute('data-price-key', it.pr);
            m.innerHTML = `<div style="height:4px; background:${b.c}; pointer-events:none;"></div>
                           <div class="mod-name" contenteditable="true">${it.n}</div>
                           <div class="mod-spec" contenteditable="true">${it.m}</div>
                           <div class="mod-ph" onclick="togglePh(this)">${it.ph}</div>`;
            rail.appendChild(m); used += it.w;
        }
        wrap.appendChild(rail); space.appendChild(wrap);
    }
    document.getElementById('pI').innerText = sumP.toFixed(1) + " кВт";
    document.getElementById('mU').innerText = sumW + " / " + (rC * rW);
    updateSpecFromShield(); initDrag();
}

function togglePh(el) {
    const is3 = document.getElementById('net').value === "3";
    if(!is3) return;
    const parent = el.closest('.mod');
    if(parent.classList.contains('L123') || parent.innerText.includes('РЕЛЕ')) return;
    const current = el.innerText;
    const next = current === 'L1' ? 'L2' : (current === 'L2' ? 'L3' : 'L1');
    parent.classList.remove('L1', 'L2', 'L3');
    parent.classList.add(next);
    el.innerText = next;
    updateBalance();
}

function saveJSON() {
    const data = { customs, settings: { brand: document.getElementById('brand').value, net: document.getElementById('net').value, inType: document.getElementById('inType').value, inAmp: document.getElementById('inAmp').value, useRelay: document.getElementById('useRelay').checked, useKM: document.getElementById('useKM').checked, heater: document.getElementById('heater').value, rCount: document.getElementById('rCount').value, rWidth: document.getElementById('rWidth').value }};
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `Shield_v17_15_${new Date().toLocaleDateString()}.json`; a.click();
}

function loadJSON(input) {
    const reader = new FileReader();
    reader.onload = function() {
        const data = JSON.parse(reader.result); customs = data.customs || [];
        for(let key in data.settings) { const el = document.getElementById(key); if(el) { if(el.type === 'checkbox') el.checked = data.settings[key]; else el.value = data.settings[key]; } }
        renderC(); gen();
    };
    reader.readAsText(input.files[0]);
}

function initDrag() {
    let draggedItem = null;
    const shield = document.getElementById('shield');
    shield.addEventListener('dragstart', (e) => { const mod = e.target.closest('.mod'); if (mod) { draggedItem = mod; mod.classList.add('dragging'); } });
    shield.addEventListener('dragend', (e) => { const mod = e.target.closest('.mod'); if (mod) { mod.classList.remove('dragging'); draggedItem = null; updateSpecFromShield(); } });
    shield.addEventListener('dragover', (e) => {
        e.preventDefault(); if(!draggedItem) return;
        const rail = e.target.closest('.rail'); if(!rail) return;
        const targetMod = e.target.closest('.mod');
        if (targetMod && targetMod !== draggedItem) {
            const rect = targetMod.getBoundingClientRect();
            if((e.clientX - rect.left) > (rect.width / 2)) rail.insertBefore(draggedItem, targetMod.nextSibling);
            else rail.insertBefore(draggedItem, targetMod);
        } else rail.appendChild(draggedItem);
    });
}

function exportCSV() {
    let csv = "\uFEFFНаименование;Артикул/Модель;Производитель;Ед. изм.;Кол-во;Цена;Сумма\n";
    document.querySelectorAll('#specBody tr').forEach(tr => { csv += Array.from(tr.cells).map(td => td.innerText).join(";") + "\n"; });
    const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8'}));
    link.download = "Spec_v17-15.csv"; link.click();
}

updateDynamic(); gen();
</script>
</body>
</html>